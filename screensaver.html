<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>iHUB Sketch 4: The Bouncer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <style>
    body, html { 
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
      background: #000; 
    }
    canvas { 
      display: block;
      /* GPU Acceleration Hints */
      will-change: transform; 
      transform: translateZ(0);
    }
  </style>
</head>
<body>
<script>
// --- CONFIGURATION ---
var speed = 3.0;        // How fast it moves
var duration = 20000;   // 20 Seconds before switching
var logoScale = 0.4;    // Size of text relative to screen height

// --- GLOBALS ---
var dvdLogo;            // The image buffer
var pos;                // Position Vector
var vel;                // Velocity Vector
var logoW, logoH;       // Dimensions
var currentColor;
var palette;
var startTime;

function setup() {
  createCanvas(windowWidth, windowHeight);
  pixelDensity(1);
  colorMode(HSB, 360, 100, 100, 100);
  
  // Define vibrant colors (Neon Palette)
  palette = [
    color(300, 100, 100), // Magenta
    color(180, 100, 100), // Cyan
    color(60, 100, 100),  // Yellow
    color(0, 100, 100),   // Red
    color(120, 100, 100), // Green
    color(280, 80, 100)   // Purple
  ];
  
  pickNewColor();
  startTime = millis();

  // 1. CREATE THE LOGO BUFFER ONCE
  // Drawing an image is much faster for the Pi than drawing text every frame
  var fontSize = height * logoScale;
  
  // Measure text first to size the buffer correctly
  textSize(fontSize);
  textStyle(BOLD);
  textFont('Arial Black', 'Impact');
  var tw = textWidth("iHUB");
  var th = textAscent() + textDescent();
  
  // Pad the buffer slightly
  logoW = tw + 20;
  logoH = th + 20;
  
  dvdLogo = createGraphics(logoW, logoH);
  dvdLogo.pixelDensity(1);
  dvdLogo.noStroke();
  dvdLogo.fill(255); // White (we will tint it later)
  dvdLogo.textAlign(LEFT, TOP);
  dvdLogo.textSize(fontSize);
  dvdLogo.textStyle(BOLD);
  dvdLogo.textFont('Arial Black', 'Impact');
  dvdLogo.text("iHUB", 0, 0);

  // 2. INITIAL PHYSICS
  pos = createVector(random(100, width - logoW), random(100, height - logoH));
  vel = createVector(speed, speed);
}

function draw() {
  // Clear background (Solid black is fastest)
  background(0);

  // 1. UPDATE PHYSICS
  pos.add(vel);

  // 2. BOUNDARY CHECKS (Bouncing)
  var hit = false;

  // Right Edge
  if (pos.x + logoW >= width) {
    pos.x = width - logoW;
    vel.x *= -1;
    hit = true;
  }
  // Left Edge
  else if (pos.x <= 0) {
    pos.x = 0;
    vel.x *= -1;
    hit = true;
  }
  
  // Bottom Edge
  if (pos.y + logoH >= height) {
    pos.y = height - logoH;
    vel.y *= -1;
    hit = true;
  }
  // Top Edge
  else if (pos.y <= 0) {
    pos.y = 0;
    vel.y *= -1;
    hit = true;
  }

  // Change color on bounce
  if (hit) {
    pickNewColor();
  }

  // 3. DRAW
  // Tint the white logo to the current color
  tint(currentColor);
  image(dvdLogo, pos.x, pos.y);

  // 4. CHECK EXIT TIMER
  if (millis() - startTime > duration) {
    if (window.parent) {
       window.parent.postMessage('nextSketch', '*');
       noLoop();
    }
  }
}

function pickNewColor() {
  // Ensure we don't pick the exact same color twice
  var newCol = random(palette);
  while (newCol === currentColor) {
    newCol = random(palette);
  }
  currentColor = newCol;
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
  // Re-initialize physics to ensure we aren't stuck outside bounds
  setup(); 
}
</script>
</body>
</html>