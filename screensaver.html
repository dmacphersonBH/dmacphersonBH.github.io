<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>iHUB Sketch 4: Silence in Noise</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <style>
    body, html { margin: 0; padding: 0; overflow: hidden; background: #000; }
    canvas { display: block; }
  </style>
</head>
<body>
<script>
// --- CONFIGURATION ---
var numLines = 60;       // More lines for higher resolution text
var amplitude = 30;      
var noiseScale = 0.005;  
var speed = 0.0001;       
var duration = 15000;    

// --- GLOBALS ---
var startMillis;
var pg; 

function setup() {
  createCanvas(windowWidth, windowHeight);
  colorMode(GRAY, 255); // Greyscale Mode
  pixelDensity(1);
  
  startMillis = millis();

  // 1. CREATE THE INVISIBLE MAP
  pg = createGraphics(width, height);
  pg.pixelDensity(1);
  pg.background(0); // Black background
  pg.fill(255);     // White Text
  pg.noStroke();
  pg.textAlign(CENTER, CENTER);
  pg.textStyle(BOLD);
  pg.textFont('Arial Black', 'Impact');
  pg.textSize(min(width, height) * 0.75); // Large text
  pg.text("iHUB", width / 2, height / 2 + 40);
  
  // Load pixels into memory so we can check them fast
  pg.loadPixels();
}

function draw() {
  background(20); // Dark Charcoal
  noFill();

  let t = millis() * speed;
  let elapsed = millis() - startMillis;

  strokeWeight(1.5);
  
  for (let i = 0; i < numLines; i++) {
    // Calculate the base Y position for this line
    let yBase = map(i, 0, numLines, height * 0.15, height * 0.85);
    
    // Aesthetic: Lighter lines at bottom, darker at top
    let lineBrightness = map(i, 0, numLines, 80, 200);
    stroke(lineBrightness, 180);

    beginShape();
    
    // Iterate across the width of the screen
    for (let x = 0; x <= width; x += 10) { // Smaller step (10) for sharper text edges
      
      // 1. CALCULATE THE WAVE
      let n = noise(x * noiseScale, i * 0.2, t);
      let s = sin(x * 0.002 + t * 5);
      let rawOffset = (n * amplitude) + (s * amplitude * 0.5);

      // 2. CHECK THE MAP
      // We look at the pixel located at (x, yBase)
      // Since yBase is a float, we floor() it.
      let px = floor(x);
      let py = floor(yBase);
      
      // Safety check to stay in bounds
      let textInfluence = 0; 
      if (px >= 0 && px < width && py >= 0 && py < height) {
        let index = (px + py * width) * 4;
        let brightness = pg.pixels[index]; // 0 to 255
        
        // If brightness is high (White), textInfluence is 1.
        // If brightness is low (Black), textInfluence is 0.
        textInfluence = brightness / 255.0; 
      }

      // 3. APPLY LOGIC
      // If we are IN text (textInfluence = 1), we want 0 movement.
      // If we are OUT of text (textInfluence = 0), we want full movement.
      // So we multiply by (1 - textInfluence).
      let finalOffset = rawOffset * (1.0 - textInfluence);

      vertex(x, yBase + finalOffset);
    }
    endShape();
  }

  // 4. CHECK FOR EXIT
  if (elapsed > duration) {
    if (window.parent) {
        window.parent.postMessage('nextSketch', '*');
        noLoop();
    }
  }
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
  setup(); // Re-generate map on resize
}
</script>
</body>
</html>