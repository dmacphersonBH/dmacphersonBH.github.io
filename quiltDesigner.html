<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fabric Quilt Designer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.3/p5.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem;
            margin: 0;
        }

        canvas {
            border: 4px solid #2d3748;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            touch-action: none;
        }

        .fabric-swatch {
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 0.5rem;
            background-size: cover;
            background-position: center;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.15s ease;
            position: relative;
        }
        
        .fabric-swatch.selected {
            border: 3px solid #3b82f6;
            transform: scale(1.1);
            box-shadow: 0 0 0 2px white, 0 4px 6px rgba(0,0,0,0.2);
        }

        .swatch-label {
            position: absolute;
            bottom: -2px;
            right: -2px;
            background: white;
            color: #374151;
            font-size: 10px;
            font-weight: bold;
            padding: 0 4px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="mx-auto flex flex-col lg:flex-row gap-8 bg-white p-8 rounded-xl shadow-2xl items-start max-w-6xl">
        
        <div class="lg:w-80 space-y-6 w-full flex-shrink-0"> 
            <div class="border-b pb-4">
                <h1 class="text-3xl font-bold text-gray-800">Quilt Tool</h1>
                <p class="text-sm text-gray-500 mt-2">3x3 Block â€¢ Fabric Scan Mode</p>
            </div>

            <div class="bg-indigo-50 p-5 rounded-lg border border-indigo-100">
                <label for="fabricInput" class="cursor-pointer bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2.5 px-4 rounded-lg block text-center transition shadow-md">
                    ðŸ“‚ Load Fabric Scans
                </label>
                <input type="file" id="fabricInput" multiple accept="image/*" class="hidden">
                <p class="text-[11px] text-indigo-700 mt-3 leading-tight italic">
                    Select your PNG/JPG scans. They will appear as swatches below.
                </p>
            </div>

            <div class="space-y-3">
                <h2 class="text-sm font-bold uppercase tracking-wider text-gray-500">Your Fabrics</h2>
                <div id="swatchContainer" class="flex flex-wrap gap-3 min-h-[100px] p-1">
                    <div class="text-gray-400 text-sm italic w-full py-4 text-center border-2 border-dashed border-gray-200 rounded-lg">
                        Upload images to start
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200 text-xs text-gray-600 space-y-2">
                <p><strong>Left-click:</strong> Apply selected fabric</p>
                <p><strong>Right-click:</strong> Erase to White</p>
                <p><strong>Keys 1-9:</strong> Select fabric shortcut</p>
            </div>
            
            <div class="pt-4 border-t border-gray-200 space-y-3">
                <button id="exportPNG" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition shadow-lg">
                    Download Block (PNG)
                </button>
                <button id="clearAll" class="w-full text-gray-400 hover:text-red-500 text-sm font-semibold transition">
                    Reset Canvas
                </button>
            </div>
        </div>

        <div class="flex-grow flex justify-center bg-gray-50 p-8 rounded-xl border border-gray-200 shadow-inner">
            <div id="p5Canvas"></div>
        </div>
    </div>

    <script>
        const ROWS = 3;
        const COLS = 3;
        const CELL_SIZE = 200; 

        let fabrics = [{ type: 'white' }]; // Index 0 is eraser
        let blockGrid = []; 
        let currentFabricIndex = 1;

        function setup() {
            const canvas = createCanvas(COLS * CELL_SIZE, ROWS * CELL_SIZE);
            canvas.parent('p5Canvas');
            initializeGrid();
            setupEventListeners();
        }

        function draw() {
            background(255);
            
            for (let i = 0; i < ROWS; i++) {
                for (let j = 0; j < COLS; j++) {
                    drawCell(i, j);
                }
            }
        }

        function drawCell(row, col) {
            const x = col * CELL_SIZE;
            const y = row * CELL_SIZE;
            const cell = blockGrid[row][col];
            const cx = x + CELL_SIZE / 2;
            const cy = y + CELL_SIZE / 2;

            const triangles = [
                { key: 'top', idx: cell.top, pts: [x, y, x + CELL_SIZE, y, cx, cy] },
                { key: 'right', idx: cell.right, pts: [x + CELL_SIZE, y, x + CELL_SIZE, y + CELL_SIZE, cx, cy] },
                { key: 'bottom', idx: cell.bottom, pts: [x + CELL_SIZE, y + CELL_SIZE, x, y + CELL_SIZE, cx, cy] },
                { key: 'left', idx: cell.left, pts: [x, y + CELL_SIZE, x, y, cx, cy] }
            ];

            triangles.forEach(t => {
                const fabric = fabrics[t.idx];
                
                if (!fabric || fabric.type === 'white') {
                    fill(255);
                    noStroke();
                    triangle(...t.pts);
                } else {
                    // MASKING
                    drawingContext.save();
                    drawingContext.beginPath();
                    drawingContext.moveTo(t.pts[0], t.pts[1]);
                    drawingContext.lineTo(t.pts[2], t.pts[3]);
                    drawingContext.lineTo(t.pts[4], t.pts[5]);
                    drawingContext.closePath();
                    drawingContext.clip();

                    // Fill the cell square with the fabric
                    image(fabric.img, x, y, CELL_SIZE, CELL_SIZE);
                    drawingContext.restore();
                }

                // Draw thin guide lines
                stroke(0, 0, 0, 20);
                strokeWeight(0.5);
                noFill();
                triangle(...t.pts);
            });
        }

        function initializeGrid() {
            blockGrid = Array.from({ length: ROWS }, () => 
                Array.from({ length: COLS }, () => ({ top: 0, right: 0, bottom: 0, left: 0 }))
            );
        }

        function applyFabric() {
            if (mouseX < 0 || mouseX > width || mouseY < 0 || mouseY > height) return;

            const col = floor(mouseX / CELL_SIZE);
            const row = floor(mouseY / CELL_SIZE);
            const rx = mouseX - col * CELL_SIZE;
            const ry = mouseY - row * CELL_SIZE;

            let key = '';
            if (ry <= rx && ry <= CELL_SIZE - rx) key = 'top';
            else if (ry > rx && ry <= CELL_SIZE - rx) key = 'left';
            else if (ry > rx && ry > CELL_SIZE - rx) key = 'bottom';
            else if (ry <= rx && ry > CELL_SIZE - rx) key = 'right';

            const targetIdx = (mouseButton === RIGHT) ? 0 : currentFabricIndex;
            if (blockGrid[row][col][key] !== targetIdx) {
                blockGrid[row][col][key] = targetIdx;
            }
        }

        function mousePressed() { applyFabric(); return false; }
        function mouseDragged() { applyFabric(); return false; }

        function handleFiles(e) {
            const files = Array.from(e.target.files);
            if (!files.length) return;

            // Reset but keep index 0
            fabrics = [{ type: 'white' }];
            let loaded = 0;

            files.forEach((file, i) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    loadImage(event.target.result, img => {
                        fabrics.push({ type: 'image', img: img, url: event.target.result });
                        loaded++;
                        if (loaded === files.length) {
                            currentFabricIndex = 1;
                            updateUI();
                        }
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        function updateUI() {
            const container = document.getElementById('swatchContainer');
            container.innerHTML = '';

            for (let i = 1; i < fabrics.length; i++) {
                const btn = document.createElement('button');
                btn.className = `fabric-swatch ${i === currentFabricIndex ? 'selected' : ''}`;
                btn.style.backgroundImage = `url(${fabrics[i].url})`;
                
                const label = document.createElement('span');
                label.className = 'swatch-label';
                label.textContent = i < 10 ? i : '';
                btn.appendChild(label);

                btn.onclick = () => {
                    currentFabricIndex = i;
                    updateUI();
                };
                container.appendChild(btn);
            }
        }

        function setupEventListeners() {
            document.getElementById('fabricInput').addEventListener('change', handleFiles);
            document.getElementById('clearAll').addEventListener('click', initializeGrid);
            document.getElementById('exportPNG').addEventListener('click', () => saveCanvas('quilt-design', 'png'));
            document.addEventListener('contextmenu', e => e.preventDefault());
            
            window.keyPressed = () => {
                let n = parseInt(key);
                if (n > 0 && n < fabrics.length) {
                    currentFabricIndex = n;
                    updateUI();
                }
            };
        }
    </script>
</body>
</html>